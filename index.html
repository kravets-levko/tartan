<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tartan Demo</title>

  <style>
    .container {
      position: relative;
      margin: 0;
      padding: 0;
      border: 1px solid silver;
      text-align: left;
    }

    #editor-container,
    #canvas-container,
    #formatted-container {
      margin: 30px 50px;
    }

    #editor-container textarea {
      border: 0;
      display: block;
      width: 100%;
      height: 100px;
      padding: 3px 2px;
      box-sizing: border-box;
      resize: vertical;
      overflow-y: scroll;
    }

    #canvas-container canvas {
      width: 100%;
      height: 450px;
      border: 0;
      margin: 0;
      padding: 0;
      cursor: move;
      image-rendering: pixelated;
      -ms-interpolation-mode: nearest-neighbor;
    }

    #formatted-container pre {
      display: block;
      width: 100%;
      min-height: 1.5em;
      vertical-align: top;
      text-align: left;
      margin: 0;
      padding: 3px 2px;
    }
  </style>
</head>
<body>
  <div id="editor-container">
    <div class="container"><textarea>r#f00; R/40 Y1 R/40 [K8 Y4] Y5 R15 R5 T4 T6 [K8 W4] W/15 K4 Y/1</textarea></div>
    <div style="margin-top: 10px;"><button type="button">Rebuild</button></div>
  </div>

  <div id="canvas-container" class="container">
    <canvas></canvas>
  </div>

  <div id="formatted-container" class="container">
    <pre></pre>
  </div>

<script type="text/javascript" src="dist/tartan.js"></script>

<script type="text/javascript">
  (function() {
    var enableTimers = false;

    var canvas = document.querySelector('#canvas-container canvas');

    function createParser() {
      return tartan.parse([
        tartan.parse.stripe(),
        tartan.parse.color(),
        tartan.parse.parenthesis(),
        tartan.parse.squareBrackets(),
        tartan.parse.pivot()
      ], {
        failOnInvalidTokens: false
      }, tartan.process([
        tartan.process.optimize(),
      ]));
    }

    function createCanvasRenderer(sett) {
      return tartan.render.canvas(sett, {
        skipUnsupportedTokens: true,
        skipInvalidColors: true
      }, tartan.process([
        tartan.process.unfold({
          ignoreOrphanedPivots: true
        })
      ]));
    }

    function createMetricsCalculator() {
      return tartan.render.metrics({
        skipUnsupportedTokens: true,
        skipInvalidColors: true
      }, tartan.process([
        tartan.process.unfold({
          ignoreOrphanedPivots: true
        })
      ]));
    }

    function createFormatter() {
      return tartan.render.format({
        outputOnlyUsedColors: true
      });
    }

    function getInitialOffset() {
      return {x: 0, y: 0};
    }

    var parse = createParser();
    var render = createCanvasRenderer(null);
    var format = createFormatter();
    var metrics = createMetricsCalculator();
    var offset = getInitialOffset();

    var repaint = tartan.helpers.repaint(function() {
      enableTimers && console.time('render');
      offset = render(canvas, offset);
      enableTimers && console.timeEnd('render');
    });

    // Editor
    (function(editor, button, formatted, repaint) {
      function rebuild() {
        enableTimers && console.time('parse');
        try {
          var sett = parse(editor.value);
          render = createCanvasRenderer(sett);
          formatted.innerHTML = format(sett);
          console.log('Metrics:', metrics(sett));
          offset = getInitialOffset();
        } catch(e) {
          console.log(e);
          if (e.data) {
            console.dir(e.data);
          }
          return;
        }
        enableTimers && console.timeEnd('parse');
        repaint();
      }

      // Bind event listeners
      button.addEventListener('click', rebuild);

      // Initial paint
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
      rebuild();
    })(
      document.querySelector('#editor-container textarea'),
      document.querySelector('#editor-container button'),
      document.querySelector('#formatted-container pre'),
      repaint);

    // Canvas
    (function(canvas, repaint) {
      var drag = null;
      canvas.addEventListener('mousedown', function(event) {
        event = event || window.event;
        if (event.button == 0) {
          drag = {
            x: event.offsetX,
            y: event.offsetY
          };
          if (event.target && event.target.setCapture) {
            // Only IE and FF
            event.target.setCapture();
          }
        }
      });
      canvas.addEventListener('mousemove', function(event) {
        event = event || window.event;
        if (drag) {
          offset.x += event.offsetX - drag.x;
          offset.y += event.offsetY - drag.y;

          drag.x = event.offsetX;
          drag.y = event.offsetY;

          repaint();
        }
      });
      canvas.addEventListener('mouseup', function(event) {
        event = event || window.event;
        if (event.button == 0) {
          drag = null;
          if (document.releaseCapture) {
            // Only IE and FF
            document.releaseCapture();
          }
        }
        repaint();
      });
      canvas.addEventListener('losecapture', function() {
        // Only IE and FF
        drag = null;
      });

      window.addEventListener('resize', function() {
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
        repaint();
      });
    })(canvas, repaint);
  })();
</script>

</body>
</html>